<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Checkout</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="https://cdn.reflowhq.com/v2/toolkit.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/Navbar-Right-Links-Dark-icons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/Profile-Edit-Form-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/Profile-Edit-Form.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='salesamigo-logo.png') }}">
    <style>
        .badge {
            font-size: 0.75rem;
            min-width: 1rem;
            padding: 0.25rem 0.4rem;
            border-radius: 0.5rem;
        }

        #view-cart-link {
            background-color: #f0f0f0;
        }

        #view-cart-link:hover {
            background-color: #e1e1e1 !important;
        }

        .flash-messages {
            text-align: center;
        }

        a.card-link {
        text-decoration: none;
        }   

        .card-title,
        .card-text {
            color: black;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #66afe9;
        }

        input[type="submit"] {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        input[type="submit"]:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-md bg-dark py-3 navbar-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="{{ url_for('home') }}">
                <span class="bs-icon-sm bs-icon-rounded bs-icon-primary d-flex justify-content-center align-items-center me-2 bs-icon" style="background: var(--bs-green);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-currency-dollar">
                        <path d="M4 10.781c.148 1.667 1.513 2.85 3.591 3.003V15h1.043v-1.216c2.27-.179 3.678-1.438 3.678-3.3 0-1.59-.947-2.51-2.956-3.028l-.722-.187V3.467c1.122.11 1.879.714 2.07 1.616h1.47c-.166-1.6-1.54-2.748-3.54-2.875V1H7.591v1.233c-1.939.23-3.27 1.472-3.27 3.156 0 1.454.966 2.483 2.661 2.917l.61.162v4.031c-1.149-.17-1.94-.8-2.131-1.718H4zm3.391-3.836c-1.043-.263-1.6-.825-1.6-1.616 0-.944.704-1.641 1.8-1.828v3.495l-.2-.05zm1.591 1.872c1.287.323 1.852.859 1.852 1.769 0 1.097-.826 1.828-2.2 1.939V8.73l.348.086z"></path>
                    </svg>
                </span>
                <span>Sales Amigo</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navcol-5">
                <span class="visually-hidden">Toggle navigation</span>
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navcol-5">
                <ul class="navbar-nav ms-auto">
                </ul>
                <a class="btn btn-primary ms-md-2" role="button" href="{{ url_for('logout') }}">Logout</a>
            </div>
        </div>
    </nav>
    <div class="offcanvas offcanvas-start bg-body" tabindex="-1" data-bs-backdrop="false" id="offcanvas-menu">
        <div class="offcanvas-header"><a class="link-body-emphasis d-flex align-items-center me-md-auto mb-3 mb-md-0 text-decoration-none" href="/">
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-bootstrap-fill me-3" style="font-size: 25px;">
                    <path d="M6.375 7.125V4.658h1.78c.973 0 1.542.457 1.542 1.237 0 .802-.604 1.23-1.764 1.23zm0 3.762h1.898c1.184 0 1.81-.48 1.81-1.377 0-.885-.65-1.348-1.886-1.348H6.375v2.725z"></path>
                    <path d="M4.002 0a4 4 0 0 0-4 4v8a4 4 0 0 0 4 4h8a4 4 0 0 0 4-4V4a4 4 0 0 0-4-4h-8zm1.06 12V3.545h3.399c1.587 0 2.543.809 2.543 2.11 0 .884-.65 1.675-1.483 1.816v.1c1.143.117 1.904.931 1.904 2.033 0 1.488-1.084 2.396-2.888 2.396z"></path>
                </svg><span class="fs-4">Sidebar</span></a><button class="btn-close" type="button" aria-label="Close" data-bs-dismiss="offcanvas"></button>
        </div>
    </div>
    <hr class="mt-0">
    <div class="container" style="padding-bottom: 24px;">
        <div class="row">
            <div class="col-md-6 col-lg-2">
                <ul class="nav nav-pills flex-column mb-auto">
                    <li class="nav-item">
                        <a class="nav-link link-body-emphasis" href="{{ url_for('home') }}"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-house-door me-2" style="margin-bottom: 4px;">
                            <path d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293zM2.5 14V7.707l5.5-5.5 5.5 5.5V14H10v-4a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v4z"></path>
                            </svg> Home
                        </a>
                        <a class="nav-link link-body-emphasis" href="{{ url_for('shop') }}" style="background: var(--bs-nav-pills-link-active-bg);color: var(--bs-nav-pills-link-active-color);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="white" viewBox="0 0 16 16" class="bi bi-shop me-2" style="margin-bottom: 5px;">
                            <path d="M2.97 1.35A1 1 0 0 1 3.73 1h8.54a1 1 0 0 1 .76.35l2.609 3.044A1.5 1.5 0 0 1 16 5.37v.255a2.375 2.375 0 0 1-4.25 1.458A2.371 2.371 0 0 1 9.875 8 2.37 2.37 0 0 1 8 7.083 2.37 2.37 0 0 1 6.125 8a2.37 2.37 0 0 1-1.875-.917A2.375 2.375 0 0 1 0 5.625V5.37a1.5 1.5 0 0 1 .361-.976l2.61-3.045zm1.78 4.275a1.375 1.375 0 0 0 2.75 0 .5.5 0 0 1 1 0 1.375 1.375 0 0 0 2.75 0 .5.5 0 0 1 1 0 1.375 1.375 0 1 0 2.75 0V5.37a.5.5 0 0 0-.12-.325L12.27 2H3.73L1.12 5.045A.5.5 0 0 0 1 5.37v.255a1.375 1.375 0 0 0 2.75 0 .5.5 0 0 1 1 0M1.5 8.5A.5.5 0 0 1 2 9v6h1v-5a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1v5h6V9a.5.5 0 0 1 1 0v6h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1V9a.5.5 0 0 1 .5-.5M4 15h3v-5H4zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1zm3 0h-2v3h2z"></path></svg>
                            <span style="color: white;">Shop</span>
                        </a>
                        <a class="nav-link link-body-emphasis" href="{{ url_for('rewards') }}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-cash-stack me-2" style="margin-bottom: 4px;">
                            <path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1zm7 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4"></path>
                            <path d="M0 5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1zm3 0a2 2 0 0 1-2 2v4a2 2 0 0 1 2 2h10a2 2 0 0 1 2-2V7a2 2 0 0 1-2-2z"></path>
                            </svg> Rewards
                        </a>
                    </li>
                </ul>
            </div>
            <div class="col-md-6 col-lg-9">
                <h1 style="padding-bottom: 23px;text-align: center;font-weight: bold;font-size: 38.112px;">Checkout</h1>
                <div class="container">
                    <div class="row">
                        <div class="col-md-1">
                            <a href="javascript:history.back()" class="btn btn-secondary mt-3 mt-md-0">
                                Back
                            </a>
                        </div>
                        <div class="col-md-5">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Order Summary</h5>
                                    <div id="order-summary">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Redeem Points</h5>
                                    <p>Available Points: <span id="available-points">{{ customer.points_balance }}</span></p>
                                    <button id="apply-points" class="btn btn-primary mt-3" onclick="applyPoints()">
                                        Apply Points
                                    </button>
                                    <button id="remove-points" class="btn btn-danger mt-3" onclick="removePoints()">
                                        Remove Points
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <br>
                        <br>
                    </div>
                    <div class="row">
                        <div class="col-md-1">
                        </div>
                        <div class="col-md-5">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Payment Method</h5>
                                    <form>
                                        <div class="form-group">
                                            <label for="cc-number">Credit Card Number: </label>
                                            <input type="text" id="cc-number" name="cc-number" placeholder="1234 5678 9012 3456" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="cc-expiration">Expiration Date: </label>
                                            <input type="text" id="cc-expiration" name="cc-expiration" placeholder="MM/YY" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="cc-cvc">CVC: </label>
                                            <input type="text" id="cc-cvv" name="cc-cvv" placeholder="123" required>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <br>
                            <br>
                            <button id="place-order-btn" class="btn btn-success ms-2" style="width: 362px; margin-left: 400px;">Place Order</button> 
                        </div>
                        <div class="col-md-5">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Shipping Address</h5>
                                        {{ customer.address }}
                                        <br>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <br>
                        <br>
                        <br>
                    </div>
                    <div style="display: none;" class="row">
                        <div style="display: none;" class="col-md-1">
                        </div>
                        <div style="display: none;" class="col-md-10">
                            <div class="card">
                                <div class="card-body">
                                    <div id="cart-items">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Price</th>
                                                    <th>Quantity</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody id="cart-items-body">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container text-muted py-4 py-lg-5">
        <p class="mb-0" style="color: var(--bs-emphasis-color);padding-top: -50px;padding-left: 30px;margin-right: 6px;padding-bottom: 24px;margin-top: 0px;text-align: center;margin-left: 100px;">Copyright © 2024 Sales Amigo</p>
    </div>
    <script src="{{ url_for('static', filename='bootstrap/js/bootstrap.min.js') }}"></script>
    <script src="https://cdn.reflowhq.com/v2/toolkit.min.js"></script>
    <script src="{{ url_for('static', filename='js/bs-init.js') }}"></script>
    <script src="{{ url_for('static', filename='js/Profile-Edit-Form-profile.js') }}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let cart = JSON.parse(sessionStorage.getItem('cart')) || [];
            let totalItems = 0;
            let finalPrice = 0;
            let discountPercent = 0; // Initial discount percentage
    
            function updateCartItems() {
                const cartItemsBody = document.getElementById('cart-items-body');
                cartItemsBody.innerHTML = '';
    
                cart.forEach((item, index) => {
                    const itemHtml = `
                        <tr>
                            <td>
                                <strong>${item.name || 'N/A'}</strong>
                                <br>
                                <small><strong>Description: </strong>${item.description || 'N/A'}</small>
                                <br>
                                <small><strong>Brand: </strong>${item.brand || 'N/A'}</small>
                                <br>
                                <small><strong>Size: </strong>${item.size || 'N/A'}</small>
                                <br>
                                <small><strong>Gender: </strong>${item.gender || 'N/A'}</small>
                                <br>
                                <small><strong>Colour: </strong>${item.color || 'N/A'}</small>
                            </td>
                            <td>$${item.price || '0.00'}</td>
                            <td>${item.min_quantity || 'N/A'}</td>
                            <td>$${(item.price * item.min_quantity).toFixed(2) || '0.00'}
                                <br>
                                <button class="btn btn-sm btn-danger mt-2" onclick="removeItem(${index})">Remove</button>
                            </td>
                        </tr>
                    `;
                    cartItemsBody.innerHTML += itemHtml;
                });
            }
    
            function updateOrderSummary() {
                const orderSummaryContainer = document.getElementById('order-summary');
                let total = 0;
                totalItems = 0;
    
                cart.forEach(item => {
                    total += item.price * parseInt(item.min_quantity);
                    totalItems += parseInt(item.min_quantity);
                });
    
                finalPrice = total * (1 - discountPercent / 100); // Apply discount
    
                const summaryHtml = `
                    <p>Total Items: ${totalItems || 0}</p>
                    <p>Total Price: $${total.toFixed(2) || '0.00'}</p>
                    <p>Discount: ${discountPercent}%</p>
                    <p><strong>Final Price: $${finalPrice.toFixed(2) || '0.00'}</strong></p>
                `;
                orderSummaryContainer.innerHTML = summaryHtml;
            }
    
            function removeItem(index) {
                cart.splice(index, 1);
                sessionStorage.setItem('cart', JSON.stringify(cart));
                updateCartItems();
                updateOrderSummary();
            }
    
            window.removeItem = removeItem;
    
            updateCartItems();
            updateOrderSummary();
    
            function applyPoints() {
                discountPercent = parseInt(document.getElementById('available-points').textContent);
                updateOrderSummary();
            }
    
            function removePoints() {
                discountPercent = 0;
                updateOrderSummary();
            }
    
            const applyPointsBtn = document.getElementById('apply-points');
            applyPointsBtn.addEventListener('click', applyPoints);
    
            const removePointsBtn = document.getElementById('remove-points');
            removePointsBtn.addEventListener('click', removePoints);
    
            const placeOrderBtn = document.getElementById('place-order-btn');
            placeOrderBtn.addEventListener('click', function () {
            // Prepare data to send to server
            const transactionData = {
                cart: cart,
                totalItems: totalItems,
                finalPrice: finalPrice.toFixed(2)
            };

            // Send AJAX request to server to store transaction data
            fetch('/shop/cart/checkout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(transactionData),
            })
            .then(response => response.json())
            .then(data => {
                alert('Order has been placed successfully!');
                sessionStorage.removeItem('cart'); // Clear cart after successful order
                window.location.href = '/orders'; // Redirect to orders page
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Failed to place order. Please try again.');
            });
        });
    });
    </script>
</body>

</html>